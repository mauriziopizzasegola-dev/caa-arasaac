<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>CAA – ARASAAC Didattica</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ================= BASE ================= */

body {
  font-family: Arial, sans-serif;
  background: #f2f4f7;
  padding: 20px;
  text-align: center;
}

h1 { font-size: 28px; }

/* ================= CONTROLLI ================= */

#controls {
  margin-bottom: 15px;
}

input, select {
  padding: 12px;
  font-size: 18px;
  margin: 5px;
}

button {
  padding: 12px 20px;
  font-size: 18px;
  margin: 5px;
  cursor: pointer;
}

#messages {
  margin-top: 10px;
  font-size: 18px;
  color: #b00020;
}

/* ================= AREA CAA ================= */

#pdf-content {
  max-width: 1200px;
  margin: 20px auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
}

#output {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 24px;
  justify-items: center;
}

/* ================= CARD ================= */

.card {
  width: 200px;
  border-radius: 14px;
  padding: 14px;
  border: 3px solid #000;
}

.card img {
  width: 140px;
  cursor: pointer;
}

.word {
  font-size: 22px;
  font-weight: bold;
  text-transform: uppercase;
}

/* ===== COLORI SEMANTICI ===== */
.persona { background: #ffe066; }
.verbo   { background: #b7f0c1; }
.nome    { background: #cce0ff; }

/* ================= MODALITÀ BAMBINI PICCOLI ================= */

.small .card { width: 240px; }
.small .word { font-size: 26px; }

/* ================= MODALITÀ TABLET / LIM ================= */

.tablet .card { width: 260px; }
.tablet button, .tablet input, .tablet select {
  font-size: 22px;
  padding: 16px;
}

/* ================= SALVATI ================= */

#saved {
  margin-top: 20px;
}

.saved-item {
  cursor: pointer;
  padding: 8px;
  background: #ddd;
  margin: 4px;
}
</style>
</head>

<body>


<h1>CAA – ARASAAC</h1>

<div id="controls">
  <select id="profile" onchange="caricaProfilo()">
    <option value="A">Bambino A</option>
    <option value="B">Bambino B</option>
    <option value="C">Bambino C</option>
  </select>

  <input id="sentence" placeholder="Scrivi una frase">

  <button onclick="genera()">Genera</button>
  <button onclick="scaricaPDF()">PDF</button>
  <button onclick="salvaFrase()">⭐ Salva</button>

  <label>
    <input type="checkbox" onchange="toggleSmall(this)"> Bambini piccoli
  </label>

  <label>
    <input type="checkbox" onchange="toggleTablet(this)"> Tablet / LIM
  </label>
</div>

<div id="messages"></div>

<div id="pdf-content">
  <div id="output"></div>
</div>

<div id="saved">
  <h3>Frasi salvate</h3>
  <div id="savedList"></div>
</div>

<script>
/* ================= DATI ================= */

const persone = ["io","tu","lui","lei","noi","voi","loro","bambino","bambina"];
const verbiBase = {
  "mangio":"mangiare","mangi":"mangiare","mangia":"mangiare",
  "vado":"andare","vai":"andare","va":"andare",
  "cammino":"camminare","cammina":"camminare",
  "gioco":"giocare","gioca":"giocare",
  "vedo":"vedere","vede":"vedere"
};
const stopwords = ["il","lo","la","i","gli","le","un","una","a","di","in","con","per","e","nel","nella"];

function categoria(p) {
  if (persone.includes(p)) return "persona";
  if (verbiBase[p]) return "verbo";
  return "nome";
}

function normalizza(p) {
  return verbiBase[p] || p;
}

/* ================= GENERA ================= */

async function genera() {
  const output = document.getElementById("output");
  output.innerHTML = "";
  document.getElementById("messages").textContent = "";

  const frase = document.getElementById("sentence").value
    .toLowerCase().replace(/[.,!?]/g,"");

  for (let parola of frase.split(" ")) {
    if (stopwords.includes(parola)) continue;

    const res = await fetch(`https://api.arasaac.org/api/pictograms/it/search/${parola}`);
    const dati = await res.json();
    if (!dati.length) continue;

    creaCard(parola, dati);
  }
}

/* ================= CARD + SCELTA ================= */

function creaCard(parola, dati) {
  const card = document.createElement("div");
  const cat = categoria(parola);
  card.className = `card ${cat}`;

  const img = document.createElement("img");
  img.src = `https://static.arasaac.org/pictograms/${dati[0]._id}/${dati[0]._id}_300.png`;
  img.onclick = () => scegli(img, dati);

  const label = document.createElement("div");
  label.className = "word";
  label.textContent = normalizza(parola);

  card.append(img,label);
  document.getElementById("output").appendChild(card);
}

function scegli(img, dati) {
  const i = prompt("Numero pittogramma (0–"+(dati.length-1)+")");
  if (dati[i]) {
    img.src = `https://static.arasaac.org/pictograms/${dati[i]._id}/${dati[i]._id}_300.png`;
  }
}

/* ================= PDF ================= */

async function scaricaPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape", "mm", "a4");

  const cards = document.querySelectorAll(".card");

  // layout PDF (A4 orizzontale)
  const pageWidth = pdf.internal.pageSize.getWidth();
  const startX = 15;
  const startY = 20;
  const cardWidth = 55;
  const cardHeight = 75;
  const gap = 10;

  let x = startX;
  let y = startY;

  for (let card of cards) {
    const imgEl = card.querySelector("img");
    const word = card.querySelector(".word").textContent;

    // bordo card
    pdf.setDrawColor(0);
    pdf.setLineWidth(1);
    pdf.roundedRect(x, y, cardWidth, cardHeight, 4, 4);

    // carica pittogramma
    const imgData = await imageToDataURL(imgEl.src);
    pdf.addImage(imgData, "PNG", x + 5, y + 5, cardWidth - 10, 45);

    // testo
    pdf.setFontSize(14);
    pdf.setTextColor(0);
    pdf.text(word, x + cardWidth / 2, y + 65, { align: "center" });

    // prossima card
    x += cardWidth + gap;

    // nuova riga se superiamo la larghezza
    if (x + cardWidth > pageWidth - startX) {
      x = startX;
      y += cardHeight + gap;
    }
  }

  pdf.save("frase_CAA.pdf");
}

// helper: converte immagine esterna in DataURL
function imageToDataURL(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext("2d").drawImage(img, 0, 0);
      resolve(canvas.toDataURL("image/png"));
    };
    img.src = url;
  });
}


/* ================= PROFILI ================= */

function key() {
  return "frasiCAA_"+document.getElementById("profile").value;
}

function salvaFrase() {
  const frase = document.getElementById("sentence").value;
  if (!frase) return;
  const arr = JSON.parse(localStorage.getItem(key()) || "[]");
  arr.push(frase);
  localStorage.setItem(key(), JSON.stringify(arr));
  mostra();
}

function mostra() {
  const list = document.getElementById("savedList");
  list.innerHTML = "";
  const arr = JSON.parse(localStorage.getItem(key()) || "[]");
  arr.forEach(f => {
    const d = document.createElement("div");
    d.className = "saved-item";
    d.textContent = f;
    d.onclick = () => { document.getElementById("sentence").value = f; genera(); };
    list.appendChild(d);
  });
}

function caricaProfilo() { mostra(); }

/* ================= MODALITÀ ================= */

function toggleSmall(cb) {
  document.body.classList.toggle("small", cb.checked);
}

function toggleTablet(cb) {
  document.body.classList.toggle("tablet", cb.checked);
}

mostra();
</script>

</body>
</html>
